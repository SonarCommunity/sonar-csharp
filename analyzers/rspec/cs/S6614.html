<h2>Why is this an issue?</h2>
<p>Generating a new <code>Regex</code> instance for every method call can result in costly compilations of complex patterns or large strings, leading
to slower execution times and higher memory usage.</p>
<p>Utilizing a single <code>Regex</code> instance can optimize performance and decrease memory usage by avoiding the overhead of compiling the regular
expression pattern repeatedly.</p>
<h3>What is the potential impact?</h3>
<p>We measured a significant improvement both in execution time and memory allocation. For more details see the <code>Benchmarks</code> section from
the <code>More info</code> tab.</p>
<h2>How to fix it</h2>
<p>In order to improve performance, consider moving the <code>Regex</code> constructor call outside of the method scope and ensuring that it is only
instantiated once.</p>
<p>Here are some suggestions for optimizing performance when extracting the <code>Regex</code>:</p>
<ul>
  <li> Consider defining a read-only field or property in your class. </li>
  <li> When creating the Regex, consider including the <code>RegexOptions.Compiled</code> flag. </li>
  <li> If you are using NET 7.0+, consider using the <code>[GeneratedRegex]</code> attribute to generate an optimized implementation of the specified
  regular expression. </li>
</ul>
<p>One compliant alternative when unable to extract the Regex is to use the static method <code>Regex.IsMatch</code>. Be aware, by default, the last
15 most recently used static regular expression patterns are cached.</p>
<h3>Code examples</h3>
<h4>Noncompliant code example</h4>
<pre data-diff-id="1" data-diff-type="noncompliant">
bool Matches(string inputString)
{
    var myRegex = new Regex("^[a-zA-Z]$");
    return myRegex.IsMatch(inputString);
}
</pre>
<h4>Compliant solution</h4>
<pre data-diff-id="1" data-diff-type="compliant">
readonly Regex myRegex = new Regex("^[a-zA-Z]$");

bool IsAMatch(string inputString) =&gt;
    ipv6Regex.IsMatch(inputString);
</pre>
<h2>Resources</h2>
<h3>Documentation</h3>
<ul>
  <li> <a href="https://learn.microsoft.com/en-us/dotnet/standard/base-types/best-practices">Best practices for regular expressions in .NET</a>
    <ul>
      <li> <a href="https://learn.microsoft.com/en-us/dotnet/standard/base-types/best-practices#static-regular-expressions">Best practices for
      <strong>static</strong> regular expressions</a> </li>
    </ul>  </li>
  <li> <a
  href="https://learn.microsoft.com/en-us/dotnet/api/system.text.regularexpressions.regexoptions#system-text-regularexpressions-regexoptions-compiled">RegexOptions.Compiled flag</a> </li>
  <li> <a href="https://learn.microsoft.com/en-us/dotnet/standard/base-types/regular-expression-source-generators#source-generation">Regex source
  generator</a>
    <ul>
      <li> <a href="https://learn.microsoft.com/en-us/dotnet/api/system.text.regularexpressions.generatedregexattribute">GeneratedRegexAttribute</a>
      </li>
    </ul>  </li>
  <li> <a href="https://learn.microsoft.com/en-us/dotnet/api/system.text.regularexpressions.regex.ismatch"><code>Regex.IsMatch</code> static
  method</a> </li>
</ul>
<h3>Benchmarks</h3>
<table>
  <colgroup>
    <col style="width: 20%;">
    <col style="width: 20%;">
    <col style="width: 20%;">
    <col style="width: 20%;">
    <col style="width: 20%;">
  </colgroup>
  <thead>
    <tr>
      <th>Method</th>
      <th>Runtime</th>
      <th>Mean</th>
      <th>Ratio</th>
      <th>Allocated</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><p>CreateMultiple</p></td>
      <td><p>.NET 7.0</p></td>
      <td><p>29.645 ms</p></td>
      <td><p>1.00</p></td>
      <td><p>69200016 B</p></td>
    </tr>
    <tr>
      <td><p>UseCached</p></td>
      <td><p>.NET 7.0</p></td>
      <td><p>2.052 ms</p></td>
      <td><p>0.07</p></td>
      <td><p>2 B</p></td>
    </tr>
    <tr>
      <td><p>CreateMultiple</p></td>
      <td><p>.NET Framework 4.6.2</p></td>
      <td><p>42.102 ms</p></td>
      <td><p>1.00</p></td>
      <td><p>125729652 B</p></td>
    </tr>
    <tr>
      <td><p>UseCached</p></td>
      <td><p>.NET Framework 4.6.2</p></td>
      <td><p>3.283 ms</p></td>
      <td><p>0.08</p></td>
      <td><p>-</p></td>
    </tr>
  </tbody>
</table>
<p>The results were generated by running the following snippet with <a href="https://github.com/dotnet/BenchmarkDotNet">BenchmarkDotNet</a>:</p>
<pre>
[Params(10_000)]
public int Iterations;

// IPV4 Regex pattern
private const string RegexPattern = "^((25[0-5]|(2[0-4]|1\\d|[1-9]|)\\d)\\.?\b){4}$";
private readonly Regex cachedRegex = new Regex(RegexPattern);

[Benchmark(Baseline = true)]
public void CreateMultiple()
{
    for (int i = 0; i &lt; Iterations; i++)
    {
        var regex = new Regex(RegexPattern);
        _ = regex.IsMatch("127.0.0.1");
    }
}

[Benchmark]
public void UseCached()
{
    for (int i = 0; i &lt; Iterations; i++)
    {
        _ = cachedRegex.IsMatch("127.0.0.1");
    }
}
</pre>
<p>Hardware configuration:</p>
<pre>
BenchmarkDotNet=v0.13.5, OS=Windows 10 (10.0.19045.2846/22H2/2022Update)
12th Gen Intel Core i7-12800H, 1 CPU, 20 logical and 14 physical cores
.NET SDK=7.0.203
  [Host]               : .NET 7.0.5 (7.0.523.17405), X64 RyuJIT AVX2
  .NET 7.0             : .NET 7.0.5 (7.0.523.17405), X64 RyuJIT AVX2
  .NET Framework 4.6.2 : .NET Framework 4.8 (4.8.4614.0), X64 RyuJIT VectorSize=256
</pre>

