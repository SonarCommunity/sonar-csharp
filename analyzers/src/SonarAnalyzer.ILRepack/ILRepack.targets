<?xml version="1.0" encoding="utf-8" ?>
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

    <!--
        This is a fix for https://github.com/SonarSource/sonar-dotnet/issues/4808
        This target needs to be executed only after the SonarAnalyzer.RuleDescriptorGenerator build.
        See details in https://github.com/SonarSource/sonar-dotnet/pull/4878#issuecomment-915319964
    -->

    <!-- Only merge for Release to avoid the overhead for debug builds -->
    <Target Name="ILRepacker" DependsOnTargets="" AfterTargets="Build" Condition="'$(Configuration)' == 'Release'" >

    <PropertyGroup>
        <SonarCSharpAssemblyName>SonarAnalyzer.CSharp</SonarCSharpAssemblyName>
        <SonarCSharpOutputPath>$(MSBuildProjectDirectory)\..\$(SonarCSharpAssemblyName)\bin\$(Configuration)\$(TargetFramework)</SonarCSharpOutputPath>
    </PropertyGroup>

    <Message Text="SonarCSharpOutputPath is $(SonarCSharpOutputPath)" Importance="high"/>

    <ItemGroup>
        <InputAssemblies Include="$(SonarCSharpOutputPath)\$(SonarCSharpAssemblyName).dll" />
        <InputAssemblies Include="$(SonarCSharpOutputPath)\Newtonsoft.Json.dll" />
    </ItemGroup>
    <ItemGroup>
      <SearchDirectories Include="$(OutputPath)" />
    </ItemGroup>
    <ILRepack
        Parallel="true"
        Verbose="false"
        Internalize="true"
        InputAssemblies="@(InputAssemblies)"
        LibraryPath="@(SearchDirectories)"
        TargetKind="Dll"
        OutputFile="$(SonarCSharpOutputPath)\$(SonarCSharpAssemblyName).dll"
    />

    </Target>
</Project>
